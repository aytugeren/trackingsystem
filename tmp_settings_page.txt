"use client"
import { useEffect, useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'

async function getMilyem(): Promise<number> {
  const base = process.env.NEXT_PUBLIC_API_BASE || ''
  const res = await fetch(`${base}/api/settings/milyem`, { cache: 'no-store', headers: authHeaders() })
  if (!res.ok) throw new Error('Ayar alÄ±namadÄ±')
  const j = await res.json()
  return Number(j.value ?? 1000)
}

async function setMilyem(v: number): Promise<void> {
  const base = process.env.NEXT_PUBLIC_API_BASE || ''
  const res = await fetch(`${base}/api/settings/milyem`, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ value: v }) })
  if (!res.ok) throw new Error('Ayar kaydedilemedi')
}

function authHeaders(): HeadersInit {
  try {
    const token = localStorage.getItem('ktp_token') || ''
    return token ? { Authorization: `Bearer ${token}` } : {}
  } catch { return {} }
}

export default function SettingsPage() {
  const [role, setRole] = useState<string | null>(null)
  const [milyem, setMilyemState] = useState<number>(1000)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')

  useEffect(() => {
    try { setRole(localStorage.getItem('ktp_role')) } catch {}
    (async () => {
      try {
        setError('')
        setLoading(true)
        const v = await getMilyem()
        setMilyemState(v)
      } catch { setError('YÃ¼klenemedi') } finally { setLoading(false) }
    })()
  }, [])

  if (role !== 'Yonetici') return <p className="text-sm text-muted-foreground">Bu sayfa iÃ§in yetkiniz yok.</p>

  return (
    <Card>
      <CardHeader>
        <CardTitle>Sistem AyarlarÄ±</CardTitle>
      </CardHeader>
      <CardContent>
        {error && <p className="text-red-600 mb-2">{error}</p>}
        {loading ? <p>YÃ¼kleniyorâ€¦</p> : (
          <div className="flex items-end gap-3">
            <div className="flex flex-col">
              <label className="text-sm text-muted-foreground">KÃ¢r Milyemi (â€°) â€” Ã–rn: 25 â‡’ +%2.5 satÄ±ÅŸ</label>
              <input type="number" value={milyem} onChange={e => setMilyemState(parseFloat(e.target.value || '0'))} className="border rounded px-3 py-2 w-40" />
            </div>
            <Button onClick={async () => { await setMilyem(milyem) }}>Kaydet</Button>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
